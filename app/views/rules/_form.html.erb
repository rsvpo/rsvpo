<script src="<%= ENV['CF'] %>jquery.ui.timepicker.js"></script>

<% start_date = params[:start_date].to_datetime.strftime('%F') if params[:start_date] %>
<% start_time = params[:start_date].to_datetime.strftime('%I:%M %p') if params[:start_date] %>
<% end_time = (params[:start_date].to_datetime + 30.minutes).strftime('%I:%M %p') if params[:start_date] %>


<%= bootstrap_form_for @rule, layout: :horizontal, label_col: "col-sm-3", control_col: "col-sm-9", html: {novalidate: 'novalidate'} do |f| %>
  <%= f.text_area :description, rows: 5 %>
  <%= f.form_group :is_all_day do %>
  <%= f.check_box :is_all_day, label: "Is all day" %>
  <% end %>
  <% if params[:start_date] %>
    <%= f.text_field :from_date, {:class => 'datepicker', :value => "#{start_date}"} %>
  <% else %>
    <%= f.text_field :from_date, {:class => 'datepicker'} %>
  <% end %>
  <div class="rule_time">
    <% if params[:start_date] %>
      <%= f.text_field :from_time, {:class => 'timepicker', :value => "#{start_time}"} %>
    <% else %>
      <%= f.text_field :from_time, {:class => 'timepicker'} %>
    <% end %>
  </div>
  <% if params[:start_date] %>
    <%= f.text_field :to_date, {:class => 'datepicker', :value => "#{start_date}"} %>
  <% else %>
    <%= f.text_field :to_date, {:class => 'datepicker'} %>
  <% end %>
  <div class="rule_time">
    <% if params[:start_date] %>
      <%= f.text_field :to_time, {:class => 'timepicker', :value => "#{end_time}"} %>
    <% else %>
      <%= f.text_field :to_time, {:class => 'timepicker'} %>
    <% end %>
  </div>
  <div class="event_time">
    <%= f.hidden_field :time_zone, :value => "Hong Kong" %>
  </div>
  <%= f.select :repeats, ['never','daily','weekly','monthly','yearly'] %>
  <%= render partial: 'repeats_daily_options', locals: {f: f} %>
  <%= render partial: 'repeats_weekly_options', locals: {f: f} %>
  <%= render partial: 'repeats_monthly_options', locals: {f: f} %>
  <%= render partial: 'repeats_yearly_options', locals: {f: f} %>
  <div class="rule_option" id="repeats_options">
    <%= f.select :repeat_ends, ['never','on'] %>
    <div id="rule_repeat_ends_on">
      <%= f.date_select :repeat_ends_on, {}, {style: 'width:auto;'} %>
    </div>
  </div>
  <div class="form_group">
    <%= link_to 'Cancel', root_path, :class => 'btn btn-danger' %>
    <%= f.submit 'Save', :class => "btn btn-default" %>
  </div>
</div>

<% end %>

<script>
  function toggle_repeats_yearly_on() {
    if($('#rule_repeats_yearly_on').is(':checked')){
      $('#rule_repeats_yearly_on_options').show();
    } else {
      $('#rule_repeats_yearly_on_options').hide();
    }
  }
  function toggle_rule_times() {
    if($('#rule_is_all_day').is(':checked')){
      $('.rule_time').hide();
    } else {
      $('.rule_time').show();
    }
  }
  function toggle_rule_options() {
    $('.rule_option').hide();
    switch ($('#rule_repeats').val())
    {
    case 'never':
      // Nothing
      break;
    case 'daily':
      $('#repeats_options').show();
      $('#repeats_daily_options').show();
      break;
    case 'weekly':
      $('#repeats_options').show();
      $('#repeats_weekly_options').show();
      break;
    case 'monthly':
      $('#repeats_options').show();
      $('#repeats_monthly_options').show();
      break;
    case 'yearly':
      $('#repeats_options').show();
      $('#repeats_yearly_options').show();
      break;
    }
  }
  function toggle_repeat_ends_on() {
    switch ($('#rule_repeat_ends').val())
    {
    case 'never':
      $('#rule_repeat_ends_on').hide();
      break;
    case 'on':
      $('#rule_repeat_ends_on').show();
      break;
    }
  }
  function toggle_repeats_monthly() {
    switch ($('#rule_repeats_monthly').val())
    {
    case 'each':
      $('#rule_repeats_monthly_each').show();
      $('#rule_repeats_monthly_on').hide();
      break;
    case 'on':
      $('#rule_repeats_monthly_each').hide();
      $('#rule_repeats_monthly_on').show();
      break;
    }
  }
</script>
<script>
  $(document).ready(function() {
    toggle_repeats_yearly_on();
    $('#rule_repeats_yearly_on').on('change',function(){
      toggle_repeats_yearly_on();
    });
    toggle_rule_times();
    $('#rule_is_all_day').on('change',function(){
      toggle_rule_times();
    });
    toggle_rule_options();
    $('#rule_repeats').on('change',function(){
      toggle_rule_options();
    });
    toggle_repeat_ends_on();
    $('#rule_repeat_ends').on('change',function(){
      toggle_repeat_ends_on();
    });
    toggle_repeats_monthly();
    $('#rule_repeats_monthly').on('change',function(){
      toggle_repeats_monthly();
    });
    $('.timepicker').timepicker();
  });
</script>
